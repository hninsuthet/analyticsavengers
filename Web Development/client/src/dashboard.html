<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Dashboard</title>
	<link rel="icon" type="image/png" href="logo.png">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<!-- Popper.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<!-- Axios -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

	<!--EXTERNAL CSS FILE-->
	<!--link rel="stylesheet" href="dashboard.css"-->


	<style>
		.container-box {
			border: 1px solid #ddd;
			padding: 20px;
			margin-bottom: 20px;
			border-radius: 15px;
		}

		.clv-tiers-container {
			border: 1px solid #ddd;
			padding: 40px;
			margin-bottom: 20px;
			height: 500px;
			border-radius: 15px;
			width: auto;
		}

		.clv-months-container {
			border: 1px solid #ddd;
			padding: 40px;
			margin-bottom: 20px;
			height: 750px;
			border-radius: 15px;
			width: auto;
		}

		.customer-profiling-container {
			border: 1px solid #ddd;
			padding: 40px;
			margin-bottom: 20px;
			height: 1450px;
			border-radius: 15px;
			width: auto;
		}

		.tooltip {
			background-color: black;
			color: white;
		}

		.custom-container {
			padding: 20px;
			border-radius: 15px;
			border: 1px solid #ddd;
			margin-bottom: 10px;
		}
	</style>
</head>

<body>
	<div class="container-fluid w-75">
		<h1 class="mt-3 mb-4">Dashboard</h1>
		<div class="row">
			<div class="col-md-3">
				<div class="container-box">
					<h6>Total Revenue</h6>
					<h4 id="box1-revenue"></h4>
				</div>
			</div>
			<div class="col-md-3">
				<div class="container-box">
					<h6>Customers</h6>
					<h4 id="box2-customers"></h4>
				</div>
			</div>
			<div class="col-md-3">
				<div class="container-box text-left">
					<h6>Average Customer Lifespan</h6>
					<h4 id="box3-lifespan"></h4>
				</div>
			</div>
			<div class="col-md-3">
				<div class="container-box">
					<h6>Average Customer Lifetime Value</h6>
					<h4 id="box4-lifetime-value"></h4>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12">
				<div class="clv-tiers-container">
					<h3>Customer Lifetime Value (CLV) Across Tiers</h3>
					<p>Explore customer groups based on their customer lifetime value (CLV): High, Middle, and Low. <br>
						See their current revenue and potential future earnings over the next 6 months.</p>
					<!-- CLV Tier Chart and Legend will appear here -->
					<div class="row">
						<div id="chart1-container" class="col-md-9"></div>
						<div id="legend1-container" class="col-md-3"></div>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12">
				<div class="clv-months-container">
					<h3>CLV Tier Customer Distribution vs Monthly Sales Performance</h3>
					<p>The first chart compares customer distribution across CLV tiers with monthly sales performance.
						The second
						chart compares average CLV with monthly sales performance. <br>
						See how different customer segments and average CLV contribute to revenue generation across the
						months.</p>
					<!--Monthly Chart will appear here-->
					<div class="row">
						<div id="chart2-container" class="col-md-9"></div>
						<div id="legend2-container" class="col-md-3"></div>
					</div>
					<div class="row">
						<div id="chart3-container" class="col-md-9"></div>
						<div id="legend3-container" class="col-md-3"></div>
					</div>
					<div class="row">
						<div id="insights-container" class="col-md-12"></div>
					</div>
				</div>
			</div>
		</div>

		<!--START OF FINAL CUSTOMER PROFILING -->
		<div class="row">
			<!--Start of Whole Customer Profiling Row-->
			<div class="col-md-12">
				<div class="customer-profiling-container">
					<h3>Subtier Demographics</h3>
					<p>Click on different sub-tiers to discover details for each customer group in every tier. <br>
						Explore country and gender distribution, bestselling categories, and order details to understand
						each tier's
						customers better.</p>
					<h3 id="selectedSubTierHeading">Selected Subtier:</h3>
					<!-- Details of Selected RFM Subtier will appear here-->
					<p id="subTierDetails"></p>

					<!-- Customer Profiling Tabs High, Medium, Low will appear here-->
					<div class="row">
						<ul class="nav nav-pills" id="dropdownMenu">
						</ul>
					</div>

					<!-- Total Number of Customers, Average Order Value and Average Number of Items Bought will appear here-->
					<div class="row">
						<!--Start of Total number of customers, average order value and average number of items div-->

						<div class="col-md-4">
							<div class="container-box">
								<h5>Total Number of Customers</h5>
								<h4 id="st_no_customers"></h4>
							</div>
						</div>

						<div class="col-md-4">
							<div class="container-box">
								<h5>Average Order Value</h5>
								<h4 id="st_avg_order_value"></h4>
							</div>
						</div>

						<div class="col-md-4">
							<div class="container-box text-left">
								<h5>Average Number of Items Bought</h5>
								<h4 id="st_avg_no_items_bought"></h4>
							</div>

						</div>
						<!--End of Total number of customers, average order value and average number of items div-->

						<!--Start of Best Selling Products-->
						<div class="col-md-12">
							<div class="container-box">
								<h5>Best Selling Products</h5>
								<div class="best_selling_products_div">
									<svg id="best_selling_products_chart"></svg>
								</div>

								</ol>

							</div>

						</div>
						<!--End of Best Selling Products-->


						<!--Start of Customer Profiling -->
						<div class="col-md-12">
							<h3>Customer Profiling</h3>
						</div>


						<!--Start of Gender-->
						<div class="col-md-5">
							<div class="container-box">
								<h5>Gender</h5>
								<svg id="donutChart"></svg>
							</div>
						</div>
						<!--End of Gender-->


						<!--Start of Countries-->
						<div class="col-md-7">
							<div class="container-box">
								<h5>Countries</h5>
								<ol id="countries">

								</ol>

							</div>
						</div>
						<!--End of Countries-->

						<!--Start of Suggested Strategies-->
						<h3>Suggested Strategy</h3>


						<!--End of Suggested Strategies-->






						<!--End of Customer Profiling-->







					</div>

				</div>
			</div>
		</div>

	</div> <!--End of Subtiers-->


	</div>
	<!--END OF FINAL CUSTOMER PROFILING-->

	<!--Start oF EARNEST'S CUSTOMER PROFILING-->
	<div class="row">
		<div class="col-md-12">
			<div class="customer-profiling-container" style="border-width: 0;">
				<h3>Customer Profiling</h3>
				<p>Click on different sub-tiers to discover details for each customer group in every tier. <br>
					Explore country and gender distribution, bestselling categories, and order details to understand
					each tier's
					customers better.</p>
				<div class="row">
					<!-- Dropdown to select Sub-tier -->
					<div class="col-2">
						<div class="dropdown">
							<button class="btn btn-secondary dropdown-toggle" type="button" id="subTierDropdown"
								data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Select Subtier
							</button>
							<div class="dropdown-menu" aria-labelledby="subTierDropdown">
								<a class="dropdown-item" id="platinum-dropdown" href="#"
									onclick="showSubTier('Platinum')">Platinum</a>
								<a class="dropdown-item" href="#" onclick="showSubTier('Gold')">Gold</a>
								<a class="dropdown-item" href="#" onclick="showSubTier('Silver')">Silver</a>
								<a class="dropdown-item" href="#" onclick="showSubTier('Iron')">Iron</a>
								<a class="dropdown-item" href="#" onclick="showSubTier('Lead')">Lead</a>
							</div>
						</div>
					</div>
					<div class="col-10">
						<div id="subtier" style="font-weight: bolder; font-style: italic;"></div>
					</div>
				</div>
				<!-- Sub-tier containers (initially hidden) -->
				<div id="Platinum" class="subtier-content" style="display: none;">
					<div class="row">
						<!-- Averages Container -->
						<div class="row">

							<div class="row">
								<div id="platinum-averages" class="container custom-container" style="border-width: 0;">
									<h4>Averages</h4>
								</div>
							</div>

							<div class="row">
								<div class="col">no. of cust</div>
								<div class="col">avg order val</div>
								<div class="col">avg no. of items</div>
							</div>


						</div>
					</div>
					<!-- Bestselling Container -->
					<div class="row">
						<div class="row">
							<div id="platinum-bestselling" class="container custom-container" style="border-width: 0;">
								<h4>Best Selling Products</h4>
							</div>
						</div>

						<div class="row" id="platinum-bestsellingproducts" style="margin-left: 100px;">
						</div>
					</div>
					<!-- Demographics Container -->
					<div class="row" style="margin-top: 50px;">

						<div class="row">
							<div id="platinum-demographics" class="container custom-container" style="border-width: 0;">
								<h4>Demographics</h4>
							</div>
						</div>

						<div class="row">

							<div class="col">
								<!-- Gender Pie Chart -->
								<div id="platinum-gender-chart"></div>
								<div class="tooltip" id="tooltip1"></div>
							</div>

							<div class="col" style="margin-left: 200px;">
								<!-- Countries Stacked Bar Chart -->
								<div id="platinum-countries-chart"></div>
							</div>
						</div>
					</div>
				</div>

				<div id="Gold" class="subtier-content" style="display: none;">
					<div class="row">
						<!-- Averages Container -->
						<div class="row">
							<div class="row">
								<div id="gold-averages" class="container custom-container" style="border-width: 0;">
									<h4>Averages</h4>
								</div>
							</div>

							<div class="row">
								<div class="col">no. of cust</div>
								<div class="col">avg order val</div>
								<div class="col">avg no. of items</div>
							</div>
						</div>
					</div>
					<!-- Bestselling Container -->
					<div class="row">
						<div class="row">
							<div id="gold-bestselling" class="container custom-container" style="border-width: 0;">
								<h4>Best Selling Products</h4>
							</div>
						</div>

						<div class="row" id="gold-bestsellingproducts" style="margin-left: 100px;">
						</div>
					</div>
					<!-- Demographics Container -->
					<div class="row" style="margin-top: 50px;">

						<div class="row">
							<div id="gold-demographics" class="container custom-container" style="border-width: 0;">
								<h4>Demographics</h4>
							</div>
						</div>

						<div class="row">
							<div class="col">
								<!-- Gender Pie Chart -->
								<div id="gold-gender-chart"></div>
								<div class="tooltip" id="tooltip1"></div>
							</div>
							<div class="col" style="margin-left: 200px;">
								<!-- Countries Stacked Bar Chart -->
								<div id="gold-countries-chart"></div>
							</div>
						</div>
					</div>
				</div>

				<div id="Silver" class="subtier-content" style="display: none;">
					<div class="row">
						<!-- Averages Container -->
						<div class="row">

							<div class="row">
								<div id="silver-averages" class="container custom-container" style="border-width: 0;">
									<h4>Averages</h4>
								</div>
							</div>
							<div class="row">
								<div class="col">no. of cust</div>
								<div class="col">avg order val</div>
								<div class="col">avg no. of items</div>
							</div>
						</div>
					</div>
					<!-- Bestselling Container -->
					<div class="row">
						<div class="row">
							<div id="silver-bestselling" class="container custom-container" style="border-width: 0;">
								<h4>Best Selling Products</h4>
							</div>
						</div>
						<div class="row" id="silver-bestsellingproducts" style="margin-left: 100px;">
						</div>
					</div>
					<!-- Demographics Container -->
					<div class="row" style="margin-top: 50px;">

						<div class="row">
							<div id="silver-demographics" class="container custom-container" style="border-width: 0;">
								<h4>Demographics</h4>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<!-- Gender Pie Chart -->
								<div id="silver-gender-chart"></div>
								<div class="tooltip" id="tooltip1"></div>
							</div>
							<div class="col" style="margin-left: 200px;">
								<!-- Countries Stacked Bar Chart -->
								<div id="silver-countries-chart"></div>
							</div>
						</div>
					</div>
				</div>

				<div id="Iron" class="subtier-content" style="display: none;">
					<div class="row">
						<!-- Averages Container -->
						<div class="row">
							<div class="row">
								<div id="iron-averages" class="container custom-container" style="border-width: 0;">
									<h4>Averages</h4>
								</div>
							</div>
							<div class="row">
								<div class="col">no. of cust</div>
								<div class="col">avg order val</div>
								<div class="col">avg no. of items</div>
							</div>
						</div>
					</div>
					<!-- Bestselling Container -->
					<div class="row">
						<div class="row">
							<div id="iron-bestselling" class="container custom-container" style="border-width: 0;">
								<h4>Best Selling Products</h4>
							</div>
						</div>
						<div class="row" id="iron-bestsellingproducts" style="margin-left: 100px;">
						</div>
					</div>
					<!-- Demographics Container -->
					<div class="row" style="margin-top: 50px;">
						<div class="row">
							<div id="iron-demographics" class="container custom-container" style="border-width: 0;">
								<h4>Demographics</h4>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<!-- Gender Pie Chart -->
								<div id="iron-gender-chart"></div>
								<div class="tooltip" id="tooltip1"></div>
							</div>
							<div class="col" style="margin-left: 200px;">
								<!-- Countries Stacked Bar Chart -->
								<div id="iron-countries-chart"></div>
							</div>
						</div>
					</div>
				</div>
				<div id="Lead" class="subtier-content" style="display: none;">
					<div class="row">
						<!-- Averages Container -->
						<div class="row">
							<div class="row">
								<div id="lead-averages" class="container custom-container" style="border-width: 0;">
									<h4>Averages</h4>
								</div>
							</div>
							<div class="row">
								<div class="col">no. of cust</div>
								<div class="col">avg order val</div>
								<div class="col">avg no. of items</div>
							</div>
						</div>
					</div>
					<!-- Bestselling Container -->
					<div class="row">
						<div class="row">
							<div id="lead-bestselling" class="container custom-container" style="border-width: 0;">
								<h4>Best Selling Products</h4>
							</div>
						</div>
						<div class="row" id="lead-bestsellingproducts" style="margin-left: 100px;">
						</div>
					</div>
					<!-- Demographics Container -->
					<div class="row" style="margin-top: 50px;">
						<div class="row">
							<div id="lead-demographics" class="container custom-container" style="border-width: 0;">
								<h4>Demographics</h4>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<!-- Gender Pie Chart -->
								<div id="lead-gender-chart"></div>
								<div class="tooltip" id="tooltip1"></div>
							</div>
							<div class="col" style="margin-left: 200px;">
								<!-- Countries Stacked Bar Chart -->
								<div id="lead-countries-chart"></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<script>
				// JavaScript to show selected subtier
				function showSubTier(subTierName) {
					// Hide all subtier contents
					d3.selectAll('.subtier-content').style('display', 'none');
					// Show selected subtier content
					d3.select('#' + subTierName).style('display', 'block');
					document.getElementById("subtier").innerHTML = subTierName
				}

			</script>
		</div>
	</div>
	</div>

	</div>

	<!-- Tooltip -->
	<div class="tooltip" id="tooltip" style="opacity: 0">
		<div class="tooltip-content"></div>
	</div>


	<script>
		// JavaScript to show selected subtier
		function showSubTier(subTierName) {
			// Hide all subtier contents
			d3.selectAll('.subtier-content').style('display', 'none');
			// Show selected subtier content
			d3.select('#' + subTierName).style('display', 'block');
			document.getElementById("subtier").innerHTML = subTierName
		}

	</script>




	</div>
	</div>
	</div>

	</div>

	<!-- Tooltip -->
	<div class="tooltip" id="tooltip" style="opacity: 0">
		<div class="tooltip-content"></div>
	</div>

	<!-- Bootstrap JS and dependencies -->
	<!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>-->

	<!-- d3 JS -->
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<script>
		const FLASK1_URL = 'http://localhost:3000'
		var uid = sessionStorage.getItem('sessionId');

		window.onload = function () {
			// Make GET request to fetch data
			axios.get(`${FLASK1_URL}/get_analysed_data/${uid}`)
				.then(response => {
					// Process response data
					const chart_data = response.data;
					const metrics = JSON.parse(chart_data['metrics']);
					const clv_tier = JSON.parse(chart_data['clv_tier']);
          const monthly_clv = JSON.parse(chart_data['monthly_clv_df']);
					const customer_profiling = JSON.parse(chart_data['customer_profiling_df'])
					// const monthly_sales = JSON.parse(chart_data['monthly_sales']);
					console.log(customer_profiling)
					plot_metrics(metrics);
					plot_clv_tiers(clv_tier);
					plot_clv_tiers_monthly_sales(monthly_clv)
					plot_customer_profiling(customer_profiling)
          // filter_row_platinum(customer_profiling)
          // list_country(customer_profiling)
          // best_selling_products(customer_profiling)
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				});

			// Function to visualize data using D3.js 
			function plot_metrics(data) {
				console.log(data);
				document.getElementById("box1-revenue").innerText =
					"$" + parseFloat(data[0]["Total Revenue"]).toLocaleString('en-US', { maximumFractionDigits: 2 });

				document.getElementById("box2-customers").innerText =
					data[0]["Total Customers"];

				var lifespan = data[0]["Average Customer Lifespan"];

				if (lifespan >= 31) {
					// Convert lifespan from days to months
					lifespan = (lifespan / 30.4).toFixed(2); // Assuming 30.4 days per month on average
					document.getElementById("box3-lifespan").innerText = lifespan + " months";
				} else {
					// Leave the value as it is
					document.getElementById("box3-lifespan").innerText = lifespan + " days";
				}

				document.getElementById("box4-lifetime-value").innerText =
					"$" + parseFloat(data[0]["Average Customer Lifetime Value"]).toLocaleString('en-US', { maximumFractionDigits: 2 });
			}

			function plot_clv_tiers(data) {
				console.log(data);
				// Data processing
				// Data processing
				const tier = data.map((d) => d.Tier);
				const maxRevenue = d3.max(data, (d) => +d.Actual_Revenue);
				const maxPotentialRevenue = d3.max(data, (d) => +d.Potential_Revenue);
				const totalCustomers = d3.sum(data, (d) => +d.Number_of_Customers);

				// Set up the SVG container dimensions
				const margin = { top: 20, right: 120, bottom: 50, left: 90 };
				const width = 1000 - margin.left - margin.right;
				const height = 300 - margin.top - margin.bottom;

				// Create SVG element
				const svg = d3
					.select("#chart1-container")
					.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", `translate(${margin.left},${margin.top})`);

				// Create scales
				const xScale = d3
					.scaleLinear()
					.domain([0, maxRevenue + maxPotentialRevenue])
					.range([0, width]);

				const yScale = d3
					.scaleBand()
					.domain(tier)
					.range([0, height])
					.padding(0.1);

				// Add axes
				svg
					.append("g")
					.attr("class", "x-axis")
					.call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.format("$.2s")))
					.attr("transform", `translate(0,${height})`);

				svg.append("g")
					.attr("class", "y-axis")
					.call(d3.axisLeft(yScale));

				// Append x-axis label
				svg.append("text")
					.attr("class", "x-axis-label")
					.attr("text-anchor", "middle")
					.attr("x", width / 2)
					.attr("y", height + margin.top + 20) // Adjust the position as needed
					.text("Revenue ($)");

				// Draw bars for actual revenue
				svg
					.selectAll(".actual-bar")
					.data(data)
					.enter()
					.append("rect")
					.attr("class", "actual-bar")
					.attr("x", 0)
					.attr("y", (d) => yScale(d.Tier))
					.attr("height", yScale.bandwidth())
					.attr("width", (d) => xScale(+d.Actual_Revenue))
					.attr("fill", d => {
						if (d.Tier === "High Tier CLV") return "#2ca02c"; // Green
						else if (d.Tier === "Middle Tier CLV") return "#ff7f0e"; // Orange
						else return "#1f77b4"; // Blue
					})
					.on("mouseover", function (event, d) {
						const tooltip = d3.select("#tooltip");
						tooltip.transition().duration(200).style("opacity", 0.9);
						tooltip
							.select(".tooltip-content")
							.html(
								`<strong>Actual Revenue:</strong> $${(+d.Actual_Revenue).toLocaleString('en-US', { maximumFractionDigits: 2 })} (${d.Proportion_of_Actual_Revenue} of Total Revenue)<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', { maximumFractionDigits: 2 })}<br/>
                  <strong>Number of Customers:</strong> ${d.Number_of_Customers} (${d.Proportion_of_Customers} of Total Customers)
                  `
							);
					})
					.on("mousemove", function (event) {
						d3.select("#tooltip")
							.style("left", event.pageX + 10 + "px")
							.style("top", event.pageY - 28 + "px");
					})
					.on("mouseout", function () {
						d3.select("#tooltip")
							.transition()
							.duration(500)
							.style("opacity", 0);
					});

				// Draw bars for potential revenue
				svg
					.selectAll(".potential-bar")
					.data(data)
					.enter()
					.append("rect")
					.attr("class", "potential-bar")
					.attr("x", (d) => xScale(+d.Actual_Revenue))
					.attr("y", (d) => yScale(d.Tier))
					.attr("height", yScale.bandwidth())
					.attr("width", (d) => xScale(+d.Potential_Revenue))
					.attr("fill", d => {
						if (d.Tier === "High Tier CLV") return "#9ed9a1"; // Light Green
						else if (d.Tier === "Middle Tier CLV") return "#ffbe94"; // Light Orange
						else return "#9ecae1"; // Light Blue
					})
					.on("mouseover", function (event, d) {
						const tooltip = d3.select("#tooltip");
						tooltip.transition().duration(200).style("opacity", 0.9);
						tooltip
							.select(".tooltip-content")
							.html(
								`<strong>Potential Revenue:</strong> $${(+d.Potential_Revenue).toLocaleString('en-US', { maximumFractionDigits: 2 })}<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', { maximumFractionDigits: 2 })}<br/>
                  <strong>Number of Customers:</strong> ${d.Number_of_Customers} (${d.Proportion_of_Customers})
                  `
							);
					})
					.on("mousemove", function (event) {
						d3.select("#tooltip")
							.style("left", event.pageX + 10 + "px")
							.style("top", event.pageY - 28 + "px");
					})
					.on("mouseout", function () {
						d3.select("#tooltip")
							.transition()
							.duration(500)
							.style("opacity", 0);
					});

				// Add Number of Customers to the side of potential revenue bars
				svg
					.selectAll(".customers-text")
					.data(data)
					.enter()
					.append("text")
					.attr("class", "customers-text")
					.attr("x", (d) => xScale(+d.Actual_Revenue) + xScale(+d.Potential_Revenue) + 5) // Adjust the position as needed
					.attr("y", (d) => yScale(d.Tier) + yScale.bandwidth() / 2)
					.attr("dy", "0.35em") // Adjust vertical alignment as needed
					.style("fill", "black")
					.text((d) => `${(+d.Number_of_Customers)} Customers`);

				// Create legend
				const legendSvg = d3.select("#legend1-container")
					.append("svg")
					.attr("width", 300)
					.attr("height", height + margin.top + margin.bottom);

				// Add legend title
				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 20)
					.style("font-weight", "bold")
					.style("text-decoration", "underline")
					.text("Legend");

				// Legend 1 - High Tier Actual Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#2ca02c") // Green
					.attr("transform", "translate(0,40)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 50)
					.text("High Tier: Actual Revenue");

				// Legend 2 - High Tier Potential Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#9ed9a1") // Light Green
					.attr("transform", "translate(0,70)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 80)
					.text("High Tier: Actual Revenue");

				// Legend 3 - Middle Tier Actual Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#ff7f0e") // Orange
					.attr("transform", "translate(0,100)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 110)
					.text("Middle Tier: Actual Revenue");

				// Legend 4 - Middle Tier Potential Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#ffbe94") // Light Orange
					.attr("transform", "translate(0,130)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 140)
					.text("Middle Tier: Potential Revenue");

				// Legend 5 - Low Tier Actual Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#1f77b4") // Blue
					.attr("transform", "translate(0,160)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 170)
					.text("Low Tier: Actual Revenue");

				// Legend 6 - Low Tier Potential Revenue
				legendSvg.append("rect")
					.attr("width", 12)
					.attr("height", 12)
					.attr("fill", "#9ecae1") // Light Blue
					.attr("transform", "translate(0,190)");

				legendSvg.append("text")
					.attr("x", 20)
					.attr("y", 200)
					.text("Low Tier: Potential Revenue");
			}

      function plot_clv_tiers_monthly_sales(data) {
        console.log(data);
        // Data processing
          // Convert date strings to date objects
          const parseDate = d3.utcParse("%Y-%m");
          const formatMonth = d3.timeFormat("%b %Y");
          data.forEach(function (d) {
            d.Month = parseDate(d.Month);
            d.Month = formatMonth(d.Month);
          });

          const month = data.map((d) => d.Month);
          const revenue = data.map((d) => +d.Total_Revenue);
          const formattedRevenue = revenue.map((d) => d.toLocaleString('en-US', {maximumFractionDigits: 2}));

          // Calculate the maximum stacked value for each month
          const maxStackedValues = data.map(d => +d.Low_Tier + +d.Middle_Tier + +d.High_Tier);
          const maxStackedValue = d3.max(maxStackedValues);
          const maxRevenue = d3.max(revenue);
          const maxCLV = d3.max(data, (d) => +d.Average_CLV);

          // Set up the SVG container dimensions
          const margin = { top: 30, right: 120, bottom: 40, left: 90 };
          const width = 900 - margin.left - margin.right;
          const height = 250 - margin.top - margin.bottom;

          // ===== 1st Container: CLV vs Revenue =====
          // Create SVG element for first dual-axis chart
          const svg = d3
            .select("#chart2-container")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          // Create x-axis scale for both bar and line graphs
          const xScale = d3
            .scaleBand()
            .domain(month)
            .range([0, width])
            .padding(0.1);

          // Create y-axis scale for stacked bar chart
          const yScaleBar = d3
            .scaleLinear()
            .domain([0, maxStackedValue])
            .range([height, 0]);

          // Create y-axis scale for sales revenue line graph
          const yScaleRevenue = d3
            .scaleLinear()
            .domain([0, maxRevenue])
            .range([height, 0]);

          // Append x axis to svg
          svg
            .append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale));

          // Append left y-axis for stacked bar chart
          svg.append("g")
          .attr("class", "y-axis")
          .call(d3.axisLeft(yScaleBar));

          // Append y-axis label for stacked bar chart
          svg.append("text")
              .attr("class", "y-axis-label")
              .attr("text-anchor", "middle")
              .attr("transform", "rotate(-90)")
              .attr("x", -height / 2)
              .attr("y", -margin.left + 35) // Increase value (eg. 30 to 35) to shift right
              .text("Number of Customers");

          // Append right y-axis for revenue line chart
          svg.append("g")
          .attr("class", "y-axis")
          .attr("transform", `translate(${width}, 0)`)
          .call(d3.axisRight(yScaleRevenue));

          // Append y-axis label for revenue line chart
          svg.append("text")
              .attr("class", "y-axis-label")
              .attr("text-anchor", "middle")
              .attr("transform", `translate(${width}, ${height / 2}) rotate(90)`)
              .attr("y", margin.right - 190) // Increase value (eg. 190 to 200) to shift right
              .text("Revenue ($)");

          // Draw bars for Low Tier Customers
          svg
            .selectAll(".low-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "low-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.Low_Tier))
            .attr("fill", "#1f77b4") // Adjust color as needed
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong><u>${d.Month}</u></strong><br/>
                  <strong>Low Tier Customers:</strong> ${d.Low_Tier}<br/>
                  <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw bars for Middle Tier Customers
          svg
            .selectAll(".middle-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "middle-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier + +d.Middle_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.Middle_Tier))
            .attr("fill", "#ff7f0e") // Adjust color as needed
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong><u>${d.Month}</u></strong><br/>
                  <strong>Middle Tier Customers:</strong> ${d.Middle_Tier}<br/>
                  <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw bars for High Tier Customers
          svg
            .selectAll(".high-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "high-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier + +d.Middle_Tier + +d.High_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.High_Tier))
            .attr("fill", "#2ca02c") // Adjust color as needed
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong><u>${d.Month}</u></strong><br/> 
                  <strong>High Tier Customers:</strong> ${d.High_Tier}<br/>
                  <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

        // Draw line for Total Revenue
        const RevenueLine = d3.line()
            .x((d) => xScale(d.Month) + xScale.bandwidth() / 2)
            .y((d) => yScaleRevenue(+d.Total_Revenue));

        // Show tooltip for the line chart with number of customer as y-axis
        // Append circles for each data point - for first line chart
        svg.selectAll("circle")
              .data(data)
              .enter()
              .append("circle")
              .attr("cx", d => xScale(d.Month) + xScale.bandwidth() / 2)
              .attr("cy", d => yScaleRevenue(+d.Total_Revenue))
              .attr("r", 4)
              .attr("fill", "#e41a1c")
              // Add tooltips
              .on("mouseover", function(event, d) {
                const tooltip = d3.select("#tooltip");
                tooltip.transition().duration(200).style("opacity", 0.9);
                tooltip
                  .select(".tooltip-content")
                  .html(`<strong><u> ${d.Month} </u></strong><br>
                        <strong>Revenue:</strong> $${(+d.Total_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}`)
                  .style("left", (event.pageX) + "px")
                  .style("top", (event.pageY - 28) + "px");
              })
              .on("mouseout", function(d) {
                  tooltip.transition()
                      .duration(500)
                      .style("opacity", 0);
              });

        // Create 1st legend
        const legendSvg1 = d3
          .select("#legend2-container")
          .append("svg")
          .attr("width", 350)
          .attr("height", height + margin.top + margin.bottom);

        // Add legend title
        legendSvg1.append("text")
          .attr("x", 20)
          .attr("y", 20)
          .style("font-weight", "bold") 
          .style("text-decoration", "underline") 
          .text("Legend");

        // Legend 1 - High Tier Customers
        legendSvg1
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#2ca02c")
          .attr("transform", "translate(0,40)");

        legendSvg1
          .append("text")
          .attr("x", 20)
          .attr("y", 50)
          .text("High Tier Customers");

        // Legend 2 - Middle Tier Customers
        legendSvg1
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#ff7f0e")
          .attr("transform", "translate(0,70)");

        legendSvg1
          .append("text")
          .attr("x", 20)
          .attr("y", 80)
          .text("Middle Tier Customers");

        // Legend 3 - Low Tier Customers
        legendSvg1
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#1f77b4")
          .attr("transform", "translate(0,100)");

        legendSvg1
          .append("text")
          .attr("x", 20)
          .attr("y", 110)
          .text("Low Tier Customers");
          
        // Legend 4 - Revenue
        legendSvg1
          .append("rect")
          .attr("width", 12)
          .attr("height", 2.5)
          .attr("fill", "#e41a1c")
          .attr("transform", "translate(0,135)");

        legendSvg1
          .append("text")
          .attr("x", 20)
          .attr("y", 140)
          .text("Revenue");

        // ===== 2nd Container: CLV vs Revenue =====
        // Create SVG element for second dual-axis chart
        const svg2 = d3
          .select("#chart3-container")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create y-axis scale for CLV bar chart
        const yScaleCLV = d3
          .scaleLinear()
          .domain([0, maxCLV])
          .range([height, 0]);
        
          // Append x axis to svg
        svg2
          .append("g")
          .attr("class", "x-axis")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(xScale));

        // Append left y-axis for CLV bar chart
        svg2.append("g")
          .attr("class", "y-axis")
          .call(d3.axisLeft(yScaleCLV))
          .append("text");

        // Append y-axis label for CLV bar chart
        svg2.append("text")
            .attr("class", "y-axis-label")
            .attr("text-anchor", "middle")
            .attr("transform", "rotate(-90)")
            .attr("x", -height / 2)
            .attr("y", -margin.left + 35) // Increase value (eg. 30 to 35) to shift right
            .text("Average CLV ($)");

        // Append right y-axis for sales revenue line chart
        svg2.append("g")
          .attr("class", "y-axis") 
          .attr("transform", `translate(${width}, 0)`)
          .call(d3.axisRight(yScaleRevenue));

        // Append y-axis label for revenue line chart
        svg2.append("text")
            .attr("class", "y-axis-label")
            .attr("text-anchor", "middle")
            .attr("transform", `translate(${width}, ${height / 2}) rotate(90)`)
            .attr("y", margin.right - 190) // Increase value (eg. 190 to 200) to shift right
            .text("Revenue ($)");

        // Create line generator for Average CLV
        const CLVLine = d3.line()
          .x((d) => xScale(d.Month) + xScale.bandwidth() / 2)
          .y((d) => yScaleCLV(+d.Average_CLV));

        // Create 2nd legend
        const legendSvg2 = d3
          .select("#legend3-container")
          .append("svg")
          .attr("width", 350)
          .attr("height", height + margin.top + margin.bottom);

        // Add legend title
        legendSvg2.append("text")
          .attr("x", 20)
          .attr("y", 20)
          .style("font-weight", "bold") 
          .style("text-decoration", "underline") 
          .text("Legend");

        // Legend 1 - Revenue
        legendSvg2
          .append("rect")
          .attr("width", 12)
          .attr("height", 2.5)
          .attr("fill", "#e41a1c") // red
          .attr("transform", "translate(0,45)");

        legendSvg2
          .append("text")
          .attr("x", 20)
          .attr("y", 50)
          .text("Revenue");

        // Legend 2 - Average CLV
        legendSvg2
          .append("rect")
          .attr("width", 12)
          .attr("height", 2.5)
          .attr("fill", "black") 
          .attr("transform", "translate(0,75)");

        legendSvg2
          .append("text")
          .attr("x", 20)
          .attr("y", 80)
          .text("Average CLV");
        
        // Drawing the lines for Total Revenue and Average CLV
        data.forEach((d, i) => {
          // console.log(i, month);

          // Draw line for Total Revenue for svg - for chart that has number of customers as y-axis
          svg.append("path")
              .datum(data) // Bind data to the element
              .attr("fill", "none")
              .attr("stroke", "#e41a1c") // red
              .attr("stroke-width", 2.5)
              .attr("d", RevenueLine);

          // Draw line for Total Revenue for svg2 - for chart that has average-clv as y-axis
          svg2.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "#e41a1c") // red
            .attr("stroke-width", 2)
            .attr("d", RevenueLine);
          
          // Draw line for Average CLV
          svg2.append("path")
              .datum(data)
              .attr("fill", "none")
              .attr("stroke", "black") 
              .attr("stroke-width", 2.5)
              .attr("d", CLVLine);

          // Draw circles for Total Revenue for svg2 - to show on tooltip
          svg2.selectAll(".revenue-circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "revenue-circle")
            .attr("cx", (d) => xScale(d.Month) + xScale.bandwidth() / 2)
            .attr("cy", (d) => yScaleRevenue(+d.Total_Revenue))
            .attr("r", 4)
            .attr("fill", "#e41a1c")
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong><u>${d.Month}</u></strong><br/>
                  <strong>Revenue:</strong> $${(+d.Total_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}`
                );
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw circles for Average CLV - to show the tooltip
          svg2.selectAll(".clv-circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "clv-circle")
            .attr("cx", (d) => xScale(d.Month) + xScale.bandwidth() / 2)
            .attr("cy", (d) => yScaleCLV(+d.Average_CLV))
            .attr("r", 4)
            .attr("fill", "black")
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong><u>${d.Month}</u></strong><br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}`
                );
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });
        });

        // ===== 3rd Container: Insights =====
        // Find the month of maxCLV and maxRevenue
        const maxCLVMonth = data.find(d => +d.Average_CLV === maxCLV).Month;
        const maxRevenueMonth = data.find(d => +d.Total_Revenue === maxRevenue).Month;
        
        // Add Insights if the peak of CLV and Revenue are in different months
        if (maxCLVMonth !== maxRevenueMonth) {
          document.getElementById("insights-container").innerHTML = `
            <div class="desc">
              Although revenue reached its peak in ${maxRevenueMonth} at $${maxRevenue.toLocaleString('en-US', {maximumFractionDigits: 2})}, 
              it is crucial to prioritise ${maxCLVMonth} due to its higher Customer Lifetime Value (CLV), which peaked at $${maxCLV.toLocaleString('en-US', {maximumFractionDigits: 2})}. 
              This indicates that customers were more valuable during ${maxCLVMonth} compared to ${maxRevenueMonth}.
            </div>`;
        }
      }

			function plot_customer_profiling(data) {
				var dropdownMenu = d3.select("#dropdownMenu");

				// Extract unique CLV_Tier values excluding "None"
				var uniqueTiers = Array.from(new Set(data.map(d => d.Tier))).filter(tier => tier !== "None");

				// Sort uniqueTiers
				uniqueTiers.sort();

				// Create dropdown menu items dynamically based on unique CLV_Tier values
				dropdownMenu.selectAll("li")
					.data(uniqueTiers)
					.enter()
					.append("li")
					.attr("class", "nav-item dropdown")
					.html(function (tier) {
						var subTiers = data.filter(d => d.Tier === tier).map(d => d.Sub_Tier);
						var dropdownItems = subTiers.map(subTier => `<a class="dropdown-item" href="#" onclick="updateSelectedSubTier('${subTier}')">${subTier}</a>`).join('');
						return `
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">${tier}</a>
								<div class="dropdown-menu">
								${dropdownItems}
								</div>
							</li>
							`;
					});

				// Set the default selected Sub Tier to "High-Value" in the heading
				var defaultSubTier = "High-Value";
				document.getElementById("selectedSubTierHeading").innerText = "Selected Sub Tier: " + defaultSubTier;

				//Calculate and display total number of customer for the default subtier 
				updateTotalCustomers(defaultSubTier, data)

				//Calculate and display average order value for the default subtier 
				updateAverageOrderValue(defaultSubTier, data)

				//Calculate and display average order size for the default subtier
				updateAverageOrderSize(defaultSubTier, data)

				//Calculate and display best selling products for the default subtier
				updateBestSellingProducts(defaultSubTier, data)

				//Calculate and display Gender for the default subtier 
				updateGenderDistribution(defaultSubTier, data)

				//Calculate and display Countries for the default subtier
				updateCountries(defaultSubTier, data)

				// Set event listeners for dropdown menu items
				var dropdownItems = document.querySelectorAll(".dropdown-item");
				dropdownItems.forEach(item => {
					item.addEventListener("click", function () {
						var subTier = this.innerText;
						updateSelectedSubTier(subTier, data);
					});
				});
			}

			// Function to update the selected Sub Tier heading and average order value 
			function updateSelectedSubTier(subTier, data) {
				document.getElementById("selectedSubTierHeading").innerText = "Selected Sub Tier: " + subTier;
				updateAverageOrderValue(subTier, data);
				updateTotalCustomers(subTier, data);
				updateAverageOrderSize(subTier, data);
				updateBestSellingProducts(subTier, data);
				updateGenderDistribution(subTier, data);
				updateCountries(subTier, data);
			}

			//Function to calculate and display total number of customer for a given sub-tier 
			// this needs editing
			function updateTotalCustomers(subTier, data) {
				// Filter data for the selected sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Display the average order value for the specified sub-tier
					document.getElementById("st_no_customers").innerText = entry.Num_Customers;
				} else {
					// Display a message indicating that data for the specified sub-tier was not found
					document.getElementById("st_no_customers").innerText = "Data not found for sub-tier: " + subTier;
				}
			}

			function updateAverageOrderValue(subTier, data) {
				// Find the entry for the specified sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Display the average order value for the specified sub-tier
					document.getElementById("st_avg_order_value").innerText = "$" + entry.AVG_Order_Amount;
				} else {
					// Display a message indicating that data for the specified sub-tier was not found
					document.getElementById("st_avg_order_value").innerText = "Data not found for sub-tier: " + subTier;
				}
			}

			function updateAverageOrderSize(subTier, data) {
				// Find the entry for the specified sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Round down the average order size to remove decimal places
					var avgOrderSize = Math.floor(entry.AVG_Order_Size);
					// Display the rounded average order size for the specified sub-tier
					document.getElementById("st_avg_no_items_bought").innerText = avgOrderSize;
				} else {
					// Display a message indicating that data for the specified sub-tier was not found
					document.getElementById("st_avg_no_items_bought").innerText = "Data not found for sub-tier: " + subTier;
				}
			}

			function updateBestSellingProducts(subTier, data) {
				// Find the entry for the specified sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Parse the best selling products data
					var bestSellingProductsData = JSON.parse(entry.Best_Selling_Categories.replace(/'/g, '"'));

					// Convert the data to an array of objects
					var dataArray = Object.entries(bestSellingProductsData).map(([category, value]) => ({ category, value }));

					// Set up chart dimensions
					var margin = { top: 20, right: 30, bottom: 40, left: 115 };
					var width = 1000 - margin.left - margin.right;
					var height = 300 - margin.top - margin.bottom;

					// Select the existing SVG element and remove its children
					d3.select("#best_selling_products_chart").selectAll("*").remove();

					// Append SVG to the container
					var svg = d3.select("#best_selling_products_chart")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// Set up X and Y scales
					var x = d3.scaleLinear()
						.range([0, width])
						.domain([0, d3.max(dataArray, d => d.value)]);

					var y = d3.scaleBand()
						.range([height, 0])
						.padding(0.1)
						.domain(dataArray.map(d => d.category));

					// Add X axis
					svg.append("g")
						.attr("transform", "translate(0," + height + ")")
						.call(d3.axisBottom(x));

					// Add Y axis
					svg.append("g")
						.call(d3.axisLeft(y));

					// Add bars
					svg.selectAll(".bar")
						.data(dataArray)
						.enter().append("rect")
						.attr("class", "bar")
						.attr("y", d => y(d.category))
						.attr("height", y.bandwidth())
						.attr("x", 0)
						.attr("width", d => x(d.value))
						.attr("fill", "#fcca03");
				} else {
					// Handle case where entry for the specified sub-tier is not found
					document.getElementById("best_selling_products").innerText = "No data found for sub-tier: " + subTier;
				}
			}

			function updateGenderDistribution(subTier, data) {
				// Find the entry for the specified sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Prepare the data for the donut chart
					var chartData = [
						{ category: "Female", value: +entry.Female_Proportion },
						{ category: "Male", value: +entry.Male_Proportion }
					];

					// Chart dimensions and settings
					const width = 400;
					const height = 400;
					const radius = Math.min(width, height) / 2;
					const color = d3.scaleOrdinal(["#98abc5", "#8a89a6"]);

					// Select the existing SVG element and remove its children
					d3.select("#donutChart").selectAll("*").remove();

					// SVG element for the chart
					const svg = d3.select("#donutChart")
						.attr("width", width)
						.attr("height", height)
						.append("g")
						.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

					// Arc
					const arc = d3.arc()
						.innerRadius(radius - 100)
						.outerRadius(radius - 50);

					// Pie generator
					const pie = d3.pie()
						.value(d => d.value)
						.sort(null);

					// Data join
					const arcs = svg.selectAll("arc")
						.data(pie(chartData))
						.enter()
						.append("g")
						.attr("class", "arc");

					// Append path
					arcs.append("path")
						.attr("d", arc)
						.attr("fill", d => color(d.data.category));

					// Add labels
					arcs.append("text")
						.attr("transform", d => "translate(" + arc.centroid(d) + ")")
						.attr("dy", "0.35em")
						.text(d => d.data.category + " " + d.data.value + "%");
				} else {
					// Handle case where entry for the specified sub-tier is not found
					document.getElementById("donutChart").innerHTML = "No data found for sub-tier: " + subTier;
				}
			}


			function updateCountries(subTier, data) {
				// Find the entry for the specified sub-tier
				var entry = data.find(d => d.Sub_Tier === subTier);

				if (entry) {
					// Parse the countries data
					var countriesData = JSON.parse(entry.Proportion_of_Countries.replace(/'/g, '"'));

					// Convert the data to an array of objects
					var dataArray = Object.entries(countriesData).map(([country, proportion]) => ({ country, proportion }));

					// Select the container element
					var container = d3.select("#countries");

					// Clear previous content
					container.selectAll("*").remove();

					// Set up the dimensions for the SVG
					var margin = { top: 20, right: 20, bottom: 30, left: 80 };
					var height = 300 - margin.top - margin.bottom;
					var width = 700 - margin.left - margin.right;

					// Create SVG element
					var svg = container.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// Create scales
					var y = d3.scaleBand()
						.domain(dataArray.map(d => d.country))
						.range([0, height])
						.padding(0.1);

					var x = d3.scaleLinear()
						.domain([0, d3.max(dataArray, d => d.proportion)])
						.nice()
						.range([0, width]);

					// Create bars
					svg.selectAll(".bar")
						.data(dataArray)
						.enter().append("rect")
						.attr("class", "bar")
						.attr("y", d => y(d.country))
						.attr("height", y.bandwidth())
						.attr("x", 0)
						.attr("width", d => x(d.proportion))
						.attr("fill", "#fcca03");

					// Add y-axis
					svg.append("g")
						.attr("class", "y-axis")
						.call(d3.axisLeft(y));

					// Add x-axis
					svg.append("g")
						.attr("class", "x-axis")
						.attr("transform", "translate(0," + height + ")")
						.call(d3.axisBottom(x));

				} else {
					// Handle case where entry for the specified sub-tier is not found
					document.getElementById("countries").innerHTML = "No data found for sub-tier: " + subTier;
				}
			}

			// //Fourth Row of Dashboard with the Customer Profiling
			// // Automatically show the first dropdown (Platinum) contents
      // document.addEventListener("DOMContentLoaded", function() {
      //     document.getElementById("platinum-dropdown").click();
      // });

      // const sub_tiers = ["Platinum", "Gold", "Silver", "Iron", "Lead"]
      // for (let i = 0; i < sub_tiers.length; i++){
      //    //Customers
      // // Load the CSV data
      // function filter_row_platinum(data){
      //   // Filter the row for the Platinum sub-tier


      //   const platinumData = data.find(row => row.Sub_Tier === sub_tiers[i]);
          
      //     // Prepare the gender data
      //     const genderData = [
      //         {"gender": "Female", "proportion": parseFloat(platinumData.Female_Proportion)},
      //         {"gender": "Male", "proportion": parseFloat(platinumData.Male_Proportion)}
      //     ];

          
      //     // Create the gender pie chart 
      //     const svg = d3.select("#" + sub_tiers[i].toLowerCase() + "-gender-chart").append("svg")
      //         .attr("width", 400) // Adjust as needed
      //         .attr("height", 400); // Adjust as needed

      //     const radius = Math.min(400, 400) / 2;
      //     const g = svg.append("g").attr("transform", "translate(" + 400 / 2 + "," + 400 / 2 + ")");
          
      //     const color = d3.scaleOrdinal(["#4169e1", "#ff4500"]);
          
      //     const pie = d3.pie().value(d => d.proportion);
      //     const path = d3.arc().outerRadius(radius).innerRadius(0);
          
      //     const arc = g.selectAll(".arc")
      //         .data(pie(genderData))
      //         .enter().append("g").attr("class", "arc");
          
      //     arc.append("path").attr("d", path)
      //         .attr("fill", d => color(d.data.gender));

      //     // Add labels, tooltips, etc. as needed
      // }

      // };

      // function list_country(data){
      //   const countriesString = data[i].Proportion_of_Countries.slice(1, -1);
      //   const countries = countriesString.split(','); // Assuming countries are comma-separated

      //   // Select the container and bind the countries data to create list items
      //   d3.select('#' + sub_tiers[i].toLowerCase() + '-countries-chart')
      //   .append('ol') // Changed from .selectAll('li') as we now need to append an 'ol' element
      //   .selectAll('li')
      //   .data(countries)
      //   .enter()
      //   .append('li')
      //   .text(d => d.trim()) // Trim to remove any extra spaces around country names
      //   .style('font-size', '20px') // Styling can still be applied as before
      //   .style('font-family', 'Roboto, sans-serif') // Apply any font-family
      //   .style('margin-bottom', '5px')
      //   .style('background-color', '#FAF9F6')
      //   .style('border-left', '5px solid #3498db')
      //   .style('padding', '5px 10px')
      //   .style('box-shadow', '2px 2px 5px rgba(0,0,0,0.1)')
      //   .style('transition', 'transform 0.2s'); // For hover effect

      //   // Adding hover effect to scale items
      //   d3.selectAll('#countries ol li').on('mouseover', function() {
      //       d3.select(this)
      //         .transition()
      //         .duration(200)
      //         .style('transform', 'scale(1.05)');
      //   }).on('mouseout', function() {
      //       d3.select(this)
      //         .transition()
      //         .duration(200)
      //         .style('transform', 'scale(1)');
      //   });
      // }

      // //Best Selling Products
      // function best_selling_products(data){
      //   function createBarChart(data) {
      //         const margin = {top: 30, right: 30, bottom: 70, left: 60},
      //               width = 460 - margin.left - margin.right,
      //               height = 400 - margin.top - margin.bottom;

      //         // Append the svg object to the body
      //         const svg = d3.select("#" + sub_tiers[i].toLowerCase() + "-bestsellingproducts")
      //           .append("svg")
      //             .attr("width", width + margin.left + margin.right)
      //             .attr("height", height + margin.top + margin.bottom)
      //           .append("g")
      //             .attr("transform", `translate(${margin.left},${margin.top})`);

      //         // X axis
      //         const x = d3.scaleBand()
      //           .range([ 0, width ])
      //           .domain(data.map(d => d.product))
      //           .padding(0.2);
      //         svg.append("g")
      //           .attr("transform", `translate(0,${height})`)
      //           .call(d3.axisBottom(x))
      //           .selectAll("text")
      //             .attr("transform", "translate(-10,0)rotate(-15)")
      //             .style("text-anchor", "end");

      //         // Add Y axis
      //         const y = d3.scaleLinear()
      //           .domain([0, d3.max(data, d => d.sales)])
      //           .range([ height, 0]);
      //         svg.append("g")
      //           .call(d3.axisLeft(y));

      //         // Bars
      //         svg.selectAll("mybar")
      //           .data(data)
      //           .join("rect")
      //             .attr("x", d => x(d.product))
      //             .attr("y", d => y(d.sales))
      //             .attr("width", x.bandwidth())
      //             .attr("height", d => height - y(d.sales))
      //             .attr("fill", "#69b3a2");

      //         // Optionally, add interactivity, labels, etc.
      //     }

      //     // Assuming the "Best_Selling_Products" column contains JSON-like strings
      //     // Parse the first row's "Best_Selling_Products" data
      //     for (let y = 0; y < data.length; y++){
      //       if (data[y].Sub_Tier == sub_tiers[i]){
      //         var test = data[y].Best_Selling_Products.replace(/"/g, '')
      //         var bestSellingProducts = JSON.parse(test.replace(/'/g, '"'));
              
      //       }
      //     }

      //     // Convert the object into an array of objects each containing 'product' and 'sales'
      //     var productsData = Object.keys(bestSellingProducts).map(function(key) {
      //         return { product: key, sales: bestSellingProducts[key] };
      //     });

      //     // Now, productsData is ready for use in creating the bar chart
      //     createBarChart(productsData);
      // }
		};
	</script>

</body>

</html>