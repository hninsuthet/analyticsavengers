<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    
    <style>
      .container-box {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 15px;
      }

      .big-container {
        border: 1px solid #ddd;
        padding: 40px;
        margin-bottom: 20px;
        height: 400px;
        border-radius: 15px;
        width: auto;
      }

      .legend-container {
        margin-left: 20px;
      }

      .tooltip {
        background-color: black;
        color: white;
      }

      .custom-container {
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
      }

      .big-container-profiling {
        border: 1px solid #ddd;
        padding: 40px;
        margin-bottom: 20px;
        height: 550px;
        border-radius: 15px;
        width: auto;
      }

    </style>
  </head>

  <body>
    <div class="container-fluid w-75">
      <h1 class="mt-3 mb-4">Dashboard</h1>

      <div class="row">
        <div class="col-md-3">
          <div class="container-box">
            <h6>Total Revenue</h6>
            <h4 id="box1-revenue"></h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="container-box">
            <h6>Customers</h6>
            <h4 id="box2-customers"></h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="container-box text-left">
            <h6>Average Customer Lifespan</h6>
            <h4 id="box3-lifespan"></h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="container-box">
            <h6>Average Customer Lifetime Value</h6>
            <h4 id="box4-lifetime-value"></h4>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="big-container">
            <h3>Customer Lifetime Value (CLV) Across Tiers</h3>
            <p>Explore customer groups based on their customer lifetime value (CLV): High, Middle, and Low. <br>
              See their current revenue and potential future earnings over the next 6 months.</p>
            <!-- CLV Tier Chart and Legend will appear here -->
            <div class="row">
              <div id="chart-container" class="col-md-9"></div>
              <div id="legend-container" class="col-md-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="big-container">
            <h3>CLV Tier Customer Distribution vs Monthly Sales Performance</h3>
            <p>This chart compares customer distribution across CLV tiers with monthly sales performance. <br>
              See how different customer segments contribute to total revenue and average CLV across the months.</p>
            <!--Monthly Chart will appear here-->
            <div class="row">
              <div id="month-container" class="col-md-9"></div>
              <div id="month-legend-container" class="col-md-3"></div>
            </div>
          </div>
        </div>
      </div>




      <div class="row">
        <div class="col-md-12">
          <div class="big-container-profiling">
            <h3>Customer Profiling</h3>
            <p>Click on different sub-tiers to discover details for each customer group in every tier. <br>
              Explore country and gender distribution, bestselling categories, and order details to understand each tier's customers better.</p>
              <div class="row">
            <!-- Dropdown to select Sub-tier -->
            <div class="col-2">
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="subTierDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Select Subtier
              </button>
              <div class="dropdown-menu" aria-labelledby="subTierDropdown">
                <a class="dropdown-item" href="#" onclick="showSubTier('Platinum')">Platinum</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Gold')">Gold</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Silver')">Silver</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Bronze')">Bronze</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Copper')">Copper</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Iron')">Iron</a>
                <a class="dropdown-item" href="#" onclick="showSubTier('Lead')">Lead</a>
              </div>
            </div>
            </div>
            <div class="col-10">
              <div id="subtier" style="font-weight: bolder; font-style: italic;"></div>
            </div>
          </div>
            <!-- Sub-tier containers (initially hidden) -->
            <div id="Platinum" class="subtier-content" style="display: none;"> 
                <div class="row">
                    <!-- Demographics Container -->
                    <div class="col-md-4">

                      <div class="row">
                        <div id="platinum-demographics" class="container custom-container">
                          <h4>Demographics</h4>
                        </div>
                      </div>

                      <div class="row">
                        <!-- Gender Pie Chart -->
                        <div id="platinum-gender-chart"></div>
                      </div>

                      <div class="row">
                        <!-- Countries Stacked Bar Chart -->
                        <div id="platinum-countries-chart"></div>
                      </div>
                    </div>

                    <!-- Bestselling Container -->
                    <div class="col-md-4">
                      <div class="row">
                        <div id="platinum-bestselling" class="container custom-container">
                          <h4>Best Selling Products</h4>
                        </div>
                      </div>
                      
                      <div class="row" id="platinum-bestsellingproducts"> 
                      </div>
                    </div>
                    
                    <!-- Averages Container -->
                    <div class="col-md-4">
                        <div id="platinum-averages" class="container custom-container">
                            <h4>Averages</h4>
                        </div>
                    </div>
                    
                </div>
            </div>


            <div id="Gold" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="gold-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="gold-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="gold-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="gold-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="gold-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="gold-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
            <div id="Silver" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="silver-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="silver-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="silver-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="silver-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="silver-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="silver-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
            <div id="Bronze" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="bronze-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="bronze-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="bronze-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="bronze-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="bronze-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="bronze-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
            <div id="Copper" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="copper-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="copper-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="copper-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="copper-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="copper-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="copper-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
            <div id="Iron" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="iron-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="iron-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="iron-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="iron-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="iron-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="iron-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
            <div id="Lead" class="subtier-content" style="display: none;">
              <div class="row">
                <!-- Demographics Container -->
                <div class="col-md-4">

                  <div class="row">
                    <div id="lead-demographics" class="container custom-container">
                      <h4>Demographics</h4>
                    </div>
                  </div>

                  <div class="row">
                    <!-- Gender Pie Chart -->
                    <div id="lead-gender-chart"></div>
                  </div>

                  <div class="row">
                    <!-- Countries Stacked Bar Chart -->
                    <div id="lead-countries-chart"></div>
                  </div>
                </div>

                <!-- Bestselling Container -->
                <div class="col-md-4">
                  <div class="row">
                    <div id="lead-bestselling" class="container custom-container">
                      <h4>Best Selling Products</h4>
                    </div>
                  </div>
                  
                  <div class="row" id="lead-bestsellingproducts"> 
                  </div>
                </div>
                
                <!-- Averages Container -->
                <div class="col-md-4">
                    <div id="lead-averages" class="container custom-container">
                        <h4>Averages</h4>
                    </div>
                </div>   
              </div>
            </div>
          </div>

          
          <script>
          // JavaScript to show selected subtier
          function showSubTier(subTierName) {
            // Hide all subtier contents
            d3.selectAll('.subtier-content').style('display', 'none');
            // Show selected subtier content
            d3.select('#' + subTierName).style('display', 'block');
            document.getElementById("subtier").innerHTML = subTierName
          }

          </script>



                 
          </div>
        </div>
      </div>

    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip" style="opacity: 0">
      <div class="tooltip-content"></div>
    </div>
    
    <!-- d3 JS -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      // First row summary stats (metrics) total revenue, customers, average customer lifespan, average customer lifetime value
      d3.csv("../Web Development/server/output/metrics.csv").then(function (data) {
    document.getElementById("box1-revenue").innerText =
        "$" + parseFloat(data[0]["Total Revenue"]).toLocaleString('en-US', {maximumFractionDigits: 2});
        
    document.getElementById("box2-customers").innerText =
        data[0]["Total Customers"];

    document.getElementById("box3-lifespan").innerText =
        data[0]["Average Customer Lifespan"] + " months";
        
    document.getElementById("box4-lifetime-value").innerText =
        "$" + parseFloat(data[0]["Average Customer Lifetime Value"]).toLocaleString('en-US', {maximumFractionDigits: 2});
});


      //Second Row of the Dashboard Customer Lifetime Value vs Monthly Sales
      // Load data from CSV file
      d3.csv("../Web Development/server/output/clv_tier.csv")
        .then(function (data) {
          // Set up the SVG container dimensions
          const margin = { top: 20, right: 120, bottom: 50, left: 90 };
          const width = 1000 - margin.left - margin.right;
          const height = 250 - margin.top - margin.bottom;

          // Create SVG element
          const svg = d3
            .select("#chart-container")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          // Data processing
          const tier = data.map((d) => d.Tier);
          const maxRevenue = d3.max(data, (d) => +d.Actual_Revenue);
          const maxPotentialRevenue = d3.max(data, (d) => +d.Potential_Revenue);
          const totalCustomers = d3.sum(data, (d) => +d.Number_of_Customers);

          const xScale = d3
            .scaleLinear()
            .domain([0, maxRevenue + maxPotentialRevenue])
            .range([0, width]);

          const yScale = d3
            .scaleBand()
            .domain(tier)
            .range([0, height])
            .padding(0.1);

          // Draw bars for actual revenue
          svg
            .selectAll(".actual-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "actual-bar")
            .attr("x", 0)
            .attr("y", (d) => yScale(d.Tier))
            .attr("height", yScale.bandwidth())
            .attr("width", (d) => xScale(+d.Actual_Revenue))
            .attr("fill", "#1f77b4")
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong>Actual Revenue:</strong> $${(+d.Actual_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})} (${d.Proportion_of_Actual_Revenue})<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/>
                  <strong>Number of Customers:</strong> ${d.Number_of_Customers} (${d.Proportion_of_Customers})
                  `
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw bars for potential revenue
          svg
            .selectAll(".potential-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "potential-bar")
            .attr("x", (d) => xScale(+d.Actual_Revenue))
            .attr("y", (d) => yScale(d.Tier))
            .attr("height", yScale.bandwidth())
            .attr("width", (d) => xScale(+d.Potential_Revenue))
            .attr("fill", "#ff7f0e")
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong>Potential Revenue:</strong> $${(+d.Potential_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/>
                  <strong>Number of Customers:</strong> ${d.Number_of_Customers} (${d.Proportion_of_Customers})
                  `
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Add Number of Customers to the side of potential revenue bars
          svg
            .selectAll(".customers-text")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "customers-text")
            .attr("x", (d) => xScale(+d.Actual_Revenue) + xScale(+d.Potential_Revenue) + 5) // Adjust the position as needed
            .attr("y", (d) => yScale(d.Tier) + yScale.bandwidth() / 2)
            .attr("dy", "0.35em") // Adjust vertical alignment as needed
            .style("fill", "black")
            .text((d) => `${(+d.Number_of_Customers)} Customers`);

          // Add axes
          svg
            .append("g")
            .attr("class", "x-axis")
            .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.format("$.2s")))
            .attr("transform", `translate(0,${height})`);

          svg.append("g").attr("class", "y-axis").call(d3.axisLeft(yScale));

          
          // Append x-axis label
          svg.append("text")
              .attr("class", "x-axis-label")
              .attr("text-anchor", "middle")
              .attr("x", width / 2)
              .attr("y", height + margin.top + 20) // Adjust the position as needed
              .text("Actual and Potential Revenue ($)");

          // Create legend
          const legendSvg = d3.select("#legend-container")
            .append("svg")
            .attr("width", 150)
            .attr("height", height + margin.top + margin.bottom);

          legendSvg.append("text")
            .attr("x", 20)
            .attr("y", 20)
            .style("font-weight", "bold") 
            .style("text-decoration", "underline") 
            .text("Legend");

          legendSvg.append("rect")
            .attr("width", 12)
            .attr("height", 12)
            .attr("fill", "#1f77b4")
            .attr("transform", "translate(0,40)");

          legendSvg.append("text")
            .attr("x", 20)
            .attr("y", 50)
            .text("Actual Revenue");

          legendSvg.append("rect")
            .attr("width", 12)
            .attr("height", 12)
            .attr("fill", "#ff7f0e")
            .attr("transform", "translate(0,70)");

          legendSvg.append("text")
            .attr("x", 20)
            .attr("y", 80)
            .text("Potential Revenue");
        })
        .catch(function (error) {
          console.log("Error loading the data: " + error);
        });

      //Third Row of the Dashboard Customer Lifetime Value vs Monthly Sales
      // Load data from CSV file
      d3.csv("../Web Development/server/output/monthly_clv.csv")
        .then(function (data) {
          // Set up the SVG container dimensions
          const margin = { top: 20, right: 120, bottom: 30, left: 90 };
          const width = 900 - margin.left - margin.right;
          const height = 250 - margin.top - margin.bottom;

          // Create SVG element
          const svg = d3
            .select("#month-container")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          // Data processing
          const month = data.map((d) => d.Month);
          const sales = data.map((d) => +d.Total_Revenue);

          // Calculate the maximum stacked value for each month
          const maxStackedValues = data.map(d => +d.Low_Tier + +d.Middle_Tier + +d.High_Tier);
          const maxStackedValue = d3.max(maxStackedValues);
          const maxSales = d3.max(sales);
          const maxCLV = d3.max(data, (d) => +d.Average_CLV);

          // Create x-axis scale for both charts
          const xScale = d3
            .scaleBand()
            .domain(month)
            .range([0, width])
            .padding(0.1);

          // Create y-axis scale for stacked bar chart
          const yScaleBar = d3
            .scaleLinear()
            .domain([0, maxStackedValue])
            .range([height, 0]);

          // Create y-axis scale for line chart
          const yScaleLine = d3
            .scaleLinear()
            .domain([0, maxSales])
            .range([height, 0]);

          // Create y-axis scale for line chart
          const yScaleCLV = d3
            .scaleLinear()
            .domain([0, maxCLV])
            .range([height, 0]);

          // Append x axis to svg
          svg
            .append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale));

          // Append left y-axis for stacked bar chart
          svg.append("g").attr("class", "y-axis").call(d3.axisLeft(yScaleBar)).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "-3em")
            .attr("text-anchor", "end")
            .text("Number of Customers");

          // Append right y-axis for line chart
          svg.append("g").attr("class", "y-axis").attr("transform", `translate(${width}, 0)`).call(d3.axisRight(yScaleLine)).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "3em")
            .attr("text-anchor", "end")
            .text("Revenue");

          // Append y-axis label for stacked bar chart
          svg.append("text")
              .attr("class", "y-axis-label")
              .attr("text-anchor", "middle")
              .attr("transform", "rotate(-90)")
              .attr("x", -height / 2)
              .attr("y", -margin.left + 35) // Increase value (eg. 30 to 35) to shift right
              .text("Number of Customers");

          // Append y-axis label for line chart
          svg.append("text")
              .attr("class", "y-axis-label")
              .attr("text-anchor", "middle")
              .attr("transform", `translate(${width}, ${height / 2}) rotate(90)`)
              .attr("y", margin.right - 190) // Increase value (eg. 190 to 200) to shift right
              .text("Revenue ($)");

              
          // Draw bars for Low Tier Customers
          svg
            .selectAll(".low-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "low-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.Low_Tier))
            .attr("fill", "#1f77b4") // Adjust color as needed
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong>Revenue:</strong> $${(+d.Total_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/> 
                  <strong>Low Tier Customers:</strong> ${d.Low_Tier}<br/>
                  <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw bars for Middle Tier Customers
          svg
            .selectAll(".middle-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "middle-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier + +d.Middle_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.Middle_Tier))
            .attr("fill", "#ff7f0e") // Adjust color as needed
            .on("mouseover", function (event, d) {
              const tooltip = d3.select("#tooltip");
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .select(".tooltip-content")
                .html(
                  `<strong>Revenue:</strong> $${(+d.Total_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/>
                  <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/> 
                  <strong>Middle Tier Customers:</strong> ${d.Middle_Tier}<br/>
                  <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
                );
            })
            .on("mousemove", function (event) {
              d3.select("#tooltip")
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select("#tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
            });

          // Draw bars for High Tier Customers
          svg
            .selectAll(".high-bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "high-bar")
            .attr("x", (d) => xScale(d.Month))
            .attr("y", (d) => yScaleBar(+d.Low_Tier + +d.Middle_Tier + +d.High_Tier))
            .attr("width", xScale.bandwidth())
            .attr("height", (d) => height - yScaleBar(+d.High_Tier))
            .attr("fill", "#2ca02c") // Adjust color as needed
            .on("mouseover", function (event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip
              .select(".tooltip-content")
              .html(
                `<strong>Revenue:</strong> $${(+d.Total_Revenue).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/> 
                <strong>Average CLV:</strong> $${(+d.Average_CLV).toLocaleString('en-US', {maximumFractionDigits: 2})}<br/> 
                <strong>High Tier Customers:</strong> ${d.High_Tier}<br/>
                <strong>Total Customers:</strong> ${+d.Low_Tier + +d.Middle_Tier + +d.High_Tier}`
              );
          })
          .on("mousemove", function (event) {
            d3.select("#tooltip")
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function () {
            d3.select("#tooltip")
              .transition()
              .duration(500)
              .style("opacity", 0);
          });


        // Draw line for Total Revenue
        const line = d3.line()
          .x((d) => xScale(d.Month) + xScale.bandwidth() / 2)
          .y((d) => yScaleLine(+d.Total_Revenue));

        svg.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "red")
          .attr("stroke-width", 2)
          .attr("d", line);

        // Draw line for Average CLV
        const line2 = d3.line()
          .x((d) => xScale(d.Month) + xScale.bandwidth() / 2)
          .y((d) => yScaleCLV(+d.Average_CLV));

        svg.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "black")
          .attr("stroke-width", 2)
          .attr("d", line2);

        // Create legend for stacked bar chart
        const legendSvg = d3
          .select("#month-legend-container")
          .append("svg")
          .attr("width", 350)
          .attr("height", height + margin.top + margin.bottom);

        legendSvg.append("text")
          .attr("x", 20)
          .attr("y", 20)
          .style("font-weight", "bold") 
          .style("text-decoration", "underline") 
          .text("Legend");

        legendSvg
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#2ca02c")
          .attr("transform", "translate(0,40)");

        legendSvg
          .append("text")
          .attr("x", 20)
          .attr("y", 50)
          .text("High Tier Customers");

        legendSvg
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#ff7f0e")
          .attr("transform", "translate(0,70)");

        legendSvg
          .append("text")
          .attr("x", 20)
          .attr("y", 80)
          .text("Middle Tier Customers");

        legendSvg
          .append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", "#1f77b4")
          .attr("transform", "translate(0,100)");

        legendSvg
          .append("text")
          .attr("x", 20)
          .attr("y", 110)
          .text("Low Tier Customers");

        legendSvg
          .append("rect")
          .attr("width", 12)
          .attr("height", 2)
          .attr("fill", "red")
          .attr("transform", "translate(0,135)");

        legendSvg
          .append("text")
          .attr("x", 20)
          .attr("y", 140)
          .text("Revenue");

      })
      .catch(function (error) {
        console.log("Error loading the data: " + error);
      });



      //Fourth Row of Dashboard with the Customer Profiling
      const sub_tiers = ["Platinum", "Gold", "Silver", "Bronze", "Copper", "Iron", "Lead"]
      for (let i = 0; i < sub_tiers.length; i++){
              //Customers
      // Load the CSV data
      d3.csv("../Web%20Development/server/output/customer_profiling.csv").then(data => {
          // Filter the row for the Platinum sub-tier
          const platinumData = data.find(row => row.Sub_Tier === sub_tiers[i]);
          
          // Prepare the gender data
          const genderData = [
              {gender: "Female", proportion: parseFloat(platinumData.Female_Proportion)},
              {gender: "Male", proportion: parseFloat(platinumData.Male_Proportion)}
          ];

          // Create the gender pie chart 
          const svg = d3.select("#" + sub_tiers[i].toLowerCase() + "-gender-chart").append("svg")
              .attr("width", 400) // Adjust as needed
              .attr("height", 400); // Adjust as needed

          const radius = Math.min(400, 400) / 2;
          const g = svg.append("g").attr("transform", "translate(" + 400 / 2 + "," + 400 / 2 + ")");
          
          const color = d3.scaleOrdinal(["#ffcc00", "#007bff"]);
          
          const pie = d3.pie().value(d => d.proportion);
          const path = d3.arc().outerRadius(radius).innerRadius(0);
          
          const arc = g.selectAll(".arc")
              .data(pie(genderData))
              .enter().append("g").attr("class", "arc");
          
          arc.append("path").attr("d", path)
              .attr("fill", d => color(d.data.gender));

          // Add labels, tooltips, etc. as needed
      });

                              

      //Best Selling Products
      
      d3.csv("../Web%20Development/server/output/customer_profiling.csv").then(function(data) {
        function createBarChart(data) {
              const margin = {top: 30, right: 30, bottom: 70, left: 60},
                    width = 460 - margin.left - margin.right,
                    height = 400 - margin.top - margin.bottom;

              // Append the svg object to the body
              const svg = d3.select("#" + sub_tiers[i].toLowerCase() + "-bestsellingproducts")
                .append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                .append("g")
                  .attr("transform", `translate(${margin.left},${margin.top})`);

              // X axis
              const x = d3.scaleBand()
                .range([ 0, width ])
                .domain(data.map(d => d.product))
                .padding(0.2);
              svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                  .attr("transform", "translate(-10,0)rotate(-15)")
                  .style("text-anchor", "end");

              // Add Y axis
              const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.sales)])
                .range([ height, 0]);
              svg.append("g")
                .call(d3.axisLeft(y));

              // Bars
              svg.selectAll("mybar")
                .data(data)
                .join("rect")
                  .attr("x", d => x(d.product))
                  .attr("y", d => y(d.sales))
                  .attr("width", x.bandwidth())
                  .attr("height", d => height - y(d.sales))
                  .attr("fill", "#69b3a2");

              // Optionally, add interactivity, labels, etc.
          }


          // Assuming the "Best_Selling_Products" column contains JSON-like strings
          // Parse the first row's "Best_Selling_Products" data
          for (let y = 0; y < data.length; y++){
            if (data[y].Sub_Tier == sub_tiers[i]){
              var test = data[y].Best_Selling_Products.replace(/"/g, '')
              var bestSellingProducts = JSON.parse(test.replace(/'/g, '"'));
              
            }
          }
      
          // Convert the object into an array of objects each containing 'product' and 'sales'
          var productsData = Object.keys(bestSellingProducts).map(function(key) {
              return { product: key, sales: bestSellingProducts[key] };
          });
      
          // Now, productsData is ready for use in creating the bar chart
          createBarChart(productsData);
      });
      //Order
      }

    </script>
  </body>
</html>
